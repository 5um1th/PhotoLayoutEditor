var App = React.createClass({

	displayName: 'photo-layout-editor',

	attachIames: function (images) {
		this.refs.Container.updateAttachImages(images);
	},

	/**
  * render
  */
	render: function () {
		return React.createElement(
			"div",
			{ className: "ple-editor" },
			React.createElement(Header, null),
			React.createElement(Container, { ref: "Container" }),
			React.createElement(Sidebar, { uploadScript: this.props.uploadScript, attachImages: this.attachIames })
		);
	}
});
var Container_Gridster = React.createClass({

	displayName: 'Gridster',

	gridster: null,

	componentDidMount: function () {
		var $gridster = $(ReactDOM.findDOMNode(this.refs.gridster));

		var margin = this.props.preference.inner_margin * 0.5;
		$gridster.children('ul').gridster({
			widget_margins: [margin, margin],
			widget_base_dimensions: [this.props.preference.width, this.props.preference.height]
		});

		// TODO : 플러그인 세팅
	},

	updatePreference: function (params) {
		// TODO : 환경설정에서 넘어온 값으로 gridster 업데이트 하기. 아니면 플러그인 옵션에서 컨테이너 사이즈 조절 할 수 있는지 확인해보기
		log('update preference');
		log(this.props.preference);
	},

	/**
  * render
  */
	render: function () {
		// act action
		if (typeof this[this.props.action] === 'function') {
			this[this.props.action]();
		}

		// TODO : gridster 속에 한번 싸야할거 같다. 중앙정렬 할 수 있도록..
		return React.createElement(
			'div',
			{ ref: 'gridster', className: 'gridster' },
			React.createElement(
				'ul',
				null,
				React.createElement('li', { 'data-row': '1', 'data-col': '1', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '2', 'data-col': '1', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '3', 'data-col': '1', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '1', 'data-col': '2', 'data-sizex': '2', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '2', 'data-col': '2', 'data-sizex': '2', 'data-sizey': '2' }),
				React.createElement('li', { 'data-row': '1', 'data-col': '4', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '2', 'data-col': '4', 'data-sizex': '2', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '3', 'data-col': '4', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '1', 'data-col': '5', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '3', 'data-col': '5', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '1', 'data-col': '6', 'data-sizex': '1', 'data-sizey': '1' }),
				React.createElement('li', { 'data-row': '2', 'data-col': '6', 'data-sizex': '1', 'data-sizey': '2' })
			)
		);
	}
});
var Container = React.createClass({

	displayName: 'Container',
	originalPreference: {},

	getInitialState: function () {
		return {
			preference: {
				width: 100,
				height: 100,
				max_col: 5,
				outer_margin: 10,
				inner_margin: 10
			},
			action: null,
			dynamicParameter: {}
		};
	},

	componentDidMount: function () {
		this.originalPreference = this.state.preference;
	},

	updatePreference: function (params) {
		this.setState({ preference: params, action: 'updatePreference' });
		//this.refs.gridster.updatePreference(params);
		//this.refs.navTop.closeSetting();
	},

	resetPreference: function () {
		this.setState({ preference: this.originalPreference, action: null });
	},

	updateAttachImages: function (items) {
		log('act import');
		log(items);
	},

	/**
  * Generate
  */
	generate: function () {
		log('generate output');
	},

	/**
  * render
  */
	render: function () {
		return React.createElement(
			'div',
			{ className: 'ple-container' },
			React.createElement(Container_NavTop, {
				ref: 'navTop',
				update: this.updatePreference,
				reset: this.resetPreference,
				preference: this.state.preference }),
			React.createElement(Container_Gridster, {
				ref: 'gridster',
				preference: this.state.preference,
				action: this.state.action,
				dynamicParameter: this.state.dynamicParameter }),
			React.createElement(Container_NavBottom, {
				generate: this.generate })
		);
	}
});

var Container_NavBottom = React.createClass({

	displayName: 'Nav-bottom',

	actGenerator: function () {
		log('ACTION GENERATE');
	},

	/**
  * render
  */
	render: function () {
		return React.createElement(
			'nav',
			{ className: 'nav-bottom' },
			React.createElement(
				'button',
				{ type: 'button', title: 'Generate export', onClick: this.props.generate },
				React.createElement('i', { className: 'sp-ico ico-check' }),
				React.createElement(
					'span',
					null,
					'Generate'
				)
			)
		);
	}
});
var Container_NavTop_Form = React.createClass({

	displayName: 'Form',
	form: null,

	propTypes: {
		update: React.PropTypes.func
	},

	getInitialState: function () {
		return {};
	},

	componentDidMount: function () {
		this.form = ReactDOM.findDOMNode(this.refs.form);
	},

	update: function () {
		this.props.update({
			width: parseInt(this.form.width.value),
			height: parseInt(this.form.height.value),
			max_col: parseInt(this.form.max_col.value),
			outer_margin: parseInt(this.form.outer_margin.value),
			inner_margin: parseInt(this.form.inner_margin.value)
		});
	},

	/**
  * render
  */
	render: function () {
		return React.createElement(
			"article",
			{ className: "form", id: "settings" },
			React.createElement(
				"form",
				{ method: "post", ref: "form" },
				React.createElement(
					"fieldset",
					null,
					React.createElement(
						"legend",
						{ className: "blind" },
						"Settings form"
					),
					React.createElement(
						"h1",
						null,
						"Settings"
					),
					React.createElement(
						"dl",
						null,
						React.createElement(
							"dt",
							null,
							React.createElement(
								"label",
								{ htmlhtmlFor: "frm_name" },
								"Min Width"
							)
						),
						React.createElement(
							"dd",
							null,
							React.createElement("input", {
								type: "number", name: "width", id: "frm_name",
								min: "1", max: "999", maxLength: "3",
								defaultValue: this.props.preference.width,
								required: true }),
							React.createElement(
								"span",
								null,
								"px"
							)
						)
					),
					React.createElement(
						"dl",
						null,
						React.createElement(
							"dt",
							null,
							React.createElement(
								"label",
								{ htmlFor: "frm_height" },
								"Min Height"
							)
						),
						React.createElement(
							"dd",
							null,
							React.createElement("input", {
								type: "number", name: "height", id: "frm_height",
								min: "1", max: "999",
								defaultValue: this.props.preference.height }),
							React.createElement(
								"span",
								null,
								"px"
							)
						)
					),
					React.createElement(
						"dl",
						null,
						React.createElement(
							"dt",
							null,
							React.createElement(
								"label",
								{ htmlFor: "frm_max_col" },
								"Max Column"
							)
						),
						React.createElement(
							"dd",
							null,
							React.createElement("input", {
								type: "number", name: "max_col", id: "frm_max_col",
								min: "1", max: "99",
								defaultValue: this.props.preference.max_col }),
							React.createElement(
								"span",
								null,
								"ea"
							)
						)
					),
					React.createElement(
						"dl",
						null,
						React.createElement(
							"dt",
							null,
							React.createElement(
								"label",
								{ htmlFor: "frm_outer_margin" },
								"Outer Margin"
							)
						),
						React.createElement(
							"dd",
							null,
							React.createElement("input", {
								type: "number", name: "outer_margin", id: "frm_outer_margin",
								min: "1", max: "500",
								defaultValue: this.props.preference.outer_margin }),
							React.createElement(
								"span",
								null,
								"px"
							)
						)
					),
					React.createElement(
						"dl",
						null,
						React.createElement(
							"dt",
							null,
							React.createElement(
								"label",
								{ htmlFor: "frm_inner_margin" },
								"Inner Margin"
							)
						),
						React.createElement(
							"dd",
							null,
							React.createElement("input", {
								type: "number", name: "inner_margin", id: "frm_inner_margin",
								min: "1", max: "500",
								defaultValue: this.props.preference.inner_margin }),
							React.createElement(
								"span",
								null,
								"px"
							)
						)
					)
				),
				React.createElement(
					"nav",
					null,
					React.createElement(
						"span",
						null,
						React.createElement(
							"button",
							{ type: "reset", onClick: this.props.reset },
							"Reset"
						)
					),
					React.createElement(
						"span",
						null,
						React.createElement(
							"button",
							{ type: "button", className: "submit", onClick: this.update },
							"Apply"
						)
					)
				)
			)
		);
	}
});
var Container_NavTop = React.createClass({

	displayName: 'Nav-top',

	getInitialState: function () {
		return {
			show_form: false
		};
	},

	/**
  * CLICK EVENTS
  */

	/**
  * Toggle setting form
  */
	toggleSetting: function (e) {
		var self = this;
		if (!this.state.show_form == true) {
			$(document).on('click', function (e) {
				if (!$(e.target).closest('#settings').length) {
					e.preventDefault();
					$(this).off('click');
					self.setState({ show_form: false });
				}
			});
		}
		this.setState({ show_form: !this.state.show_form });
	},

	closeSetting: function () {
		$(document).off('click');
		this.setState({ show_form: false });
	},

	/**
  * Action shuffle blocks
  */
	actShuffleBlocks: function () {
		log('action shuffle blocks');
	},

	/**
  * Action add blocks
  */
	actAddBlocks: function () {
		log('action add blocks');
	},

	/**
  * RENDER
  */
	render: function () {
		return React.createElement(
			'nav',
			{ className: 'nav-top' },
			React.createElement(
				'div',
				{ className: 'block' + (this.state.show_form ? ' is-active' : '') },
				React.createElement(
					'button',
					{ type: 'button', title: 'Edit preference', onClick: this.toggleSetting },
					React.createElement(
						'i',
						{ className: 'sp-ico ico-setting abs' },
						'Setting'
					)
				),
				React.createElement(Container_NavTop_Form, {
					update: this.props.update,
					reset: this.props.reset,
					preference: this.props.preference })
			),
			React.createElement(
				'div',
				{ className: 'block' },
				React.createElement(
					'button',
					{ type: 'button', title: 'Shuffle block', onClick: this.actShuffleBlocks },
					React.createElement(
						'i',
						{ className: 'sp-ico ico-arrow-random abs' },
						'Random block'
					)
				)
			),
			React.createElement(
				'div',
				{ className: 'block' },
				React.createElement(
					'button',
					{ type: 'button', title: 'Add block', onClick: this.actAddBlocks },
					React.createElement(
						'i',
						{ className: 'sp-ico ico-plus abs' },
						'Add block'
					)
				)
			)
		);
	}
});
function Uploader()
{
	/**
	 * Local upload
	 *
	 * @Param {Array} files
	 * @Param {Function} complete
	 * @Return {Array}
	 */
	this.local = function(files, complete)
	{
		var reader = new FileReader();
		var i = 0;
		var result = [];
		reader.onload = function(e)
		{
			result.push(e.target.result);

			// check last queue
			if (i == (files.length - 1))
			{
				complete(result);
			}
			else
			{
				// trigger next queue
				i++;
				reader.readAsDataURL(files[i]);
			}
		};
		reader.readAsDataURL(files[i]);
	};

	/**
	 * External upload
	 *
	 * @Param {String} script
	 * @Param {String} dir
	 * @Param {String} url
	 * @Param {Array} files
	 * @Param {Function} complete
	 * @Return {Array}
	 */
	this.external = function(script, dir, url, files, complete)
	{
		var xhr = new XMLHttpRequest();

		if (typeof FormData === 'function' || typeof FormData === 'object')
		{
			var formData = new FormData();

			for (var i=0; i<files.length; i++)
			{
				formData.append('files[]', files[i]);
			}
			formData.append('dir', dir);
			formData.append('url', url);

			xhr.open('post', script, true);
			xhr.addEventListener('load', function(e){
				var response = null;
				if (e.target.readyState == 4)
				{
					switch (e.target.status)
					{
						case 200:
							try {
								var result = JSON.parse(decodeURIComponent(e.target.responseText.replace(/\+/g, '%20')));
								complete(result);
							} catch(e) {
								complete({
									'state' : 'error',
									'message' : e.target.responseText
								});
							}
							break;
						case 404:
							response = {
								state : 'error',
								message : '404 - File not found'
							};
							break;
						case 403:
							response = {
								state : 'error',
								message : '403 - Forbidden file type'
							};
							break;
						default:
							response = {
								state : 'error',
								message : 'Unknown Error'
							};
							break;
					}
				}
				else
				{
					response = {
						state : 'error',
						message : 'Unknown Error'
					};
				}
			});
			xhr.send(formData);
		}

		return null;
	}
}
var Header = React.createClass({

	displayName: 'header',

	componentDidMount: function () {},

	render: function () {
		return React.createElement(
			"header",
			{ className: "ple-header" },
			React.createElement(
				"h1",
				null,
				"Photo Layout Editor"
			),
			React.createElement(
				"p",
				null,
				"사진 레이아웃 에디터입니다. 처음 시작하면 먼저 문서설정을 해주세요!"
			)
		);
	}
});
var Sidebar = React.createClass({

	displayName: 'Sidebar',

	propTypes: {
		uploadScript: React.PropTypes.string
	},

	uploader: new Uploader(),

	getDefaultProps: function () {
		return {
			uploadScript: null
		};
	},

	getInitialState: function () {
		return {
			uploadImages: [{
				on: false,
				image: './assets/img/tmp-simg-01.jpg',
				style: { backgroundImage: 'url(./assets/img/tmp-simg-01.jpg)' }
			}, {
				on: false,
				image: './assets/img/tmp-simg-02.jpg',
				style: { backgroundImage: 'url(./assets/img/tmp-simg-02.jpg)' }
			}, {
				on: false,
				image: './assets/img/tmp-simg-03.jpg',
				style: { backgroundImage: 'url(./assets/img/tmp-simg-03.jpg)' }
			}, {
				on: false,
				image: './assets/img/tmp-simg-04.jpg',
				style: { backgroundImage: 'url(./assets/img/tmp-simg-04.jpg)' }
			}],
			is_loading: false
		};
	},

	/**
  * upload images
  *
  * @Param {Files} array
  */
	upload: function (files) {
		var self = this;
		var result = null;
		var uploadFiles = [];

		for (var i = 0; i < files.length; i++) {
			uploadFiles.push(files[i]);
		}

		// on loading
		this.setState({ is_loading: true });

		// action upload
		if (this.props.uploadScript) {
			// is external script upload
			this.uploader.external(this.props.uploadScript, this.props.uploadDir, this.props.uploadUrl, uploadFiles, function (response) {
				self.setState({ is_loading: false });

				if (response.state == 'success') {
					var data = response.images;

					data.forEach(function (o) {
						self.state.uploadImages.push({
							on: false,
							image: o.loc,
							style: { backgroundImage: 'url(' + o.loc + ')' }
						});
					});
					self.setState({
						uploadImages: self.state.uploadImages
					});
				} else {
					log(response.message);
				}
			});
		} else {
			// is local upload
			this.setState({ is_loading: true });
			this.uploader.local(uploadFiles, function (data) {
				var result = self.state.uploadImages;
				self.setState({ is_loading: false });

				data.forEach(function (o) {
					result.push({
						on: false,
						image: o,
						style: { backgroundImage: 'url(' + o + ')' }
					});
				});
				self.setState({ uploadImages: result });
			});
		}
	},

	remove: function () {
		var self = this;
		var selectedKeys = [];

		if (!this.state.uploadImages.length) {
			alert('이미지가 없습니다.');
			return;
		}

		this.state.uploadImages.forEach(function (o, k) {
			if (o.on) {
				selectedKeys.push(k);
			}
		});

		if (selectedKeys.length) {
			selectedKeys.forEach(function (o) {
				delete self.state.uploadImages[o];
			});
			this.setState({ uploadImages: self.state.uploadImages });
		} else {
			if (confirm('선택된 사진이 없습니다. 전부 삭제할까요?')) {
				this.setState({ uploadImages: [] });
			}
		}
	},

	attach: function () {
		var items = [];
		this.state.uploadImages.forEach(function (o) {
			if (o.on) {
				items.push(o.image);
			}
		});
		if (items.length) {
			this.props.attachImages(items);
		} else {
			alert('please select image');
			return false;
		}
	},

	toggleSelect: function () {
		var items = this.state.uploadImages;
		var $items = $(ReactDOM.findDOMNode(this.refs.files));
		var sw = $items.find('span.on').length > 0;
		items.forEach(function (o) {
			o.on = !sw;
		});
		this.setState({ uploadImages: items });
	},

	update: function (data) {
		this.setState({ uploadImages: data });
	},

	/**
  * render
  */
	render: function () {
		return React.createElement(
			'aside',
			{ className: 'ple-sidebar' + (this.state.is_loading ? ' loading' : '') },
			React.createElement(Sidebar_Nav, { ref: 'nav', upload: this.upload, remove: this.remove, attach: this.attach, toggleSelect: this.toggleSelect }),
			React.createElement(Sidebar_UploadFiles, { ref: 'files', uploadImages: this.state.uploadImages, update: this.update })
		);
	}
});
var Sidebar_Nav = React.createClass({

	displayName: 'Navigation',

	getInitialState: function () {
		return {
			inputFile: React.createElement('input', { type: 'file', onChange: this.upload, multiple: true })
		};
	},

	/**
  * Attach images
  */
	attachImages: function () {
		log('attach image to grid block');
	},

	/**
  * Upload images
  */
	upload: function (e) {
		this.props.upload(e.target.files);

		// reset input[type=file]
		var $input = $(this.refs.inputFile);
		$input.replaceWith($input.val('').clone(true));
	},

	/**
  * render
  */
	render: function () {
		return React.createElement(
			'nav',
			{ className: 'nav-top' },
			React.createElement(
				'div',
				{ className: 'wrap' },
				React.createElement(
					'button',
					{ type: 'button', title: 'attach images', onClick: this.props.attach },
					React.createElement(
						'i',
						{ className: 'sp-ico ico-arrow-left abs' },
						'Moving the image to grid block'
					)
				),
				React.createElement(
					'button',
					{ type: 'button', title: 'toggle select', onClick: this.props.toggleSelect },
					React.createElement(
						'i',
						{ className: 'sp-ico ico-select abs' },
						'Toggle all select'
					)
				),
				React.createElement(
					'span',
					{ title: 'upload images' },
					React.createElement('input', { type: 'file', ref: 'inputFile', onChange: this.upload, multiple: true }),
					React.createElement(
						'i',
						{ className: 'sp-ico ico-upload abs' },
						'upload images'
					)
				),
				React.createElement(
					'button',
					{ type: 'button', title: 'remove images', onClick: this.props.remove },
					React.createElement(
						'i',
						{ className: 'sp-ico ico-trash abs' },
						'remove images'
					)
				)
			)
		);
	}
});
// <button type="button" onClick={this.upload}></button>

var Sidebar_UploadFiles = React.createClass({

	displayName: 'UploadFiles',

	propTypes: {
		uploadImages: React.PropTypes.array,
		update: React.PropTypes.func
	},

	getInitialState: function () {
		return {
			is_multiSelect: false
		};
	},

	componentDidMount: function () {
		var self = this;
		var CTRL = 17;
		var CMD = 91;
		function onKeydown(e) {
			if (e.keyCode == CTRL || e.keyCode == CMD) {
				self.setState({ is_multiSelect: true });
				$(this).off('keydown').on('keyup', onKeyUp);
			}
		}
		function onKeyUp(e) {
			self.setState({ is_multiSelect: false });
			$(this).off('keyup').on('keydown', onKeydown);
		}
		$(window).on('keydown', onKeydown);
	},

	onSelect: function (e) {
		var currentKey = parseInt(e.currentTarget.getAttribute('data-key'));

		if (this.state.is_multiSelect) {
			this.props.uploadImages[currentKey].on = !this.props.uploadImages[currentKey].on;
		} else {
			this.props.uploadImages.forEach(function (data, key) {
				data.on = key == currentKey ? !data.on : false;
			});
		}

		this.props.update(this.props.uploadImages);
	},

	/**
  * render
  */
	render: function () {
		var self = this;
		var items = [];

		// make item elements
		this.props.uploadImages.forEach(function (item, key) {
			items.push(React.createElement(
				'li',
				{ key: key, 'data-key': key, onClick: self.onSelect },
				React.createElement(
					'span',
					{ style: item.style, className: item.on ? 'on' : '' },
					'.img'
				)
			));
		});

		return React.createElement(
			'div',
			{ className: 'upload-files' },
			React.createElement(
				'div',
				{ className: 'wrap' },
				React.createElement(
					'ul',
					{ ref: 'items' },
					items
				)
			)
		);
	}
});
var Sidebar_UploadFiles_Item = React.createClass({

	displayName: 'Item',

	/**
  * render
  */
	render: function () {
		return React.createElement(
			'li',
			{ onClick: this.select },
			React.createElement(
				'span',
				{ style: this.props.style },
				'.img'
			)
		);
	}
});
//# sourceMappingURL=../maps/PhotoLayoutEditor.min.js.map
